<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­ç§‹æ™šä¼šèŠ‚ç›®æŠ•ç¥¨ç³»ç»Ÿ - ç®¡ç†åå°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .description {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .voting-section {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .results-section {
            flex: 2;
            min-width: 500px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .program-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .program-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .program-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
        }
        
        .program-item.selected {
            background: rgba(46, 204, 113, 0.4);
            border: 2px solid #2ecc71;
        }
        
        .program-name {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .vote-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .vote-btn:hover {
            background: #27ae60;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .vote-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        
        .vote-count {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .vote-count-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .vote-count-item:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .vote-count-number {
            font-size: 2rem;
            font-weight: bold;
            color: #f1c40f;
        }
        
        .vote-count-name {
            font-size: 1rem;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .instructions {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .qr-code {
            text-align: center;
            margin-top: 20px;
        }
        
        .qr-code img {
            max-width: 150px;
            border-radius: 10px;
            border: 3px solid white;
        }
        
        .admin-section {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
        }
        
        .admin-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .admin-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .admin-btn.reset {
            background: #e67e22;
        }
        
        .admin-btn.add {
            background: #3498db;
        }
        
        .admin-btn.delete {
            background: #e74c3c;
        }
        
        .clear-storage {
            background: #9b59b6;
        }
        
        .program-manager {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .program-manager h3 {
            margin-bottom: 10px;
            color: #f1c40f;
        }
        
        .program-manager-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .program-manager-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-bottom: 5px;
        }
        
        .program-manager-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .delete-program-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .delete-program-btn:hover {
            background: #c0392b;
        }

        .page-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .page-link {
            background: #9b59b6;
            color: white;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 150px;
            transition: all 0.3s ease;
            display: block;
        }
        
        .page-link:hover {
            background: #8e44ad;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .page-link.screen {
            background: #e67e22;
        }
        
        .page-link.screen:hover {
            background: #d35400;
        }
        
        .page-link.vote {
            background: #2ecc71;
        }
        
        .page-link.vote:hover {
            background: #27ae60;
        }

        .vote-link {
            display: block;
            background: #2ecc71;
            color: white;
            text-decoration: none;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .vote-link:hover {
            background: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .voting-section, .results-section {
                min-width: 100%;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .vote-count {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .page-links {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ä¸­ç§‹æ™šä¼šèŠ‚ç›®æŠ•ç¥¨ç³»ç»Ÿ - ç®¡ç†åå°</h1>
            <p class="description">ç®¡ç†å‘˜æ§åˆ¶é¢æ¿ - ç”¨äºç®¡ç†èŠ‚ç›®å’ŒæŸ¥çœ‹æ•°æ®</p>
        </header>
        
        <div class="page-links">
            <a href="vote.html" class="page-link vote">ğŸ“± è§‚ä¼—æŠ•ç¥¨é¡µé¢</a>
            <a href="screen.html" class="page-link screen">ğŸ“º å¤§å±å¹•æ˜¾ç¤ºé¡µé¢</a>
        </div>
        
        <div class="main-content">
            <section class="voting-section">
                <h2>æŠ•ç¥¨é¢„è§ˆåŒº</h2>
                <p>æ­¤åŒºåŸŸä»…ç”¨äºé¢„è§ˆï¼Œè§‚ä¼—è¯·ä½¿ç”¨ä¸“ç”¨æŠ•ç¥¨é¡µé¢</p>
                
                <div class="program-list" id="programList">
                    <!-- èŠ‚ç›®åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <button class="vote-btn" id="voteBtn" disabled>æäº¤æŠ•ç¥¨ï¼ˆé¢„è§ˆï¼‰</button>
                
                <div class="instructions">
                    <p><strong>è§‚ä¼—æŠ•ç¥¨æ–¹å¼ï¼š</strong></p>
                    <p>1. ç‚¹å‡»ä¸‹æ–¹è“è‰²é“¾æ¥è¿›å…¥æŠ•ç¥¨é¡µé¢</p>
                    <p>2. é€‰æ‹©å–œæ¬¢çš„èŠ‚ç›®</p>
                    <p>3. ç‚¹å‡»æäº¤æŠ•ç¥¨</p>
                    <p>4. æ¯ä¸ªè®¾å¤‡åªèƒ½æŠ•ç¥¨ä¸€æ¬¡</p>
                </div>
                
                <a href="vote.html" class="vote-link">ğŸš€ ç‚¹å‡»è¿™é‡Œè¿›å…¥æŠ•ç¥¨é¡µé¢ ğŸš€</a>
                
                <div class="instructions">
                    <p><strong>é“¾æ¥åœ°å€ï¼š</strong></p>
                    <p style="word-break: break-all; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
                        https://chenchuang11.github.io/mid-autumn-vote/vote.html
                    </p>
                    <p>è¯·å°†æ­¤é“¾æ¥åˆ†äº«ç»™è§‚ä¼—</p>
                </div>
            </section>
            
            <section class="results-section">
                <h2>å®æ—¶æŠ•ç¥¨ç»“æœ</h2>
                <p>å½“å‰å„èŠ‚ç›®å¾—ç¥¨æƒ…å†µï¼š</p>
                
                <div class="chart-container">
                    <canvas id="resultsChart"></canvas>
                </div>
                
                <div class="vote-count" id="voteCount">
                    <!-- ç¥¨æ•°ç»Ÿè®¡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>
        </div>
        
        <section class="admin-section">
            <h2>ç®¡ç†å‘˜æ§åˆ¶é¢æ¿</h2>
            <p>ç³»ç»Ÿç®¡ç†åŠŸèƒ½ï¼š</p>
            <div class="admin-controls">
                <button class="admin-btn reset" id="resetVotes">é‡ç½®æ‰€æœ‰ç¥¨æ•°</button>
                <button class="admin-btn add" id="addProgram">æ·»åŠ æ–°èŠ‚ç›®</button>
                <button class="admin-btn delete" id="deleteProgram">åˆ é™¤èŠ‚ç›®</button>
                <button class="admin-btn" id="exportData">å¯¼å‡ºæ•°æ®</button>
                <button class="admin-btn clear-storage" id="clearStorage">æ¸…é™¤æŠ•ç¥¨çŠ¶æ€</button>
            </div>
            
            <div class="program-manager">
                <h3>èŠ‚ç›®ç®¡ç†</h3>
                <p>å½“å‰èŠ‚ç›®åˆ—è¡¨ï¼š</p>
                <div class="program-manager-list" id="programManagerList">
                    <!-- èŠ‚ç›®ç®¡ç†åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div style="margin-top:15px;padding:10px;background:rgba(255,255,255,0.1);border-radius:5px;">
                <p><strong>é¡µé¢è¯´æ˜ï¼š</strong></p>
                <p>â€¢ <strong>è§‚ä¼—æŠ•ç¥¨</strong>ï¼šè¯·ä½¿ç”¨ vote.html é¡µé¢</p>
                <p>â€¢ <strong>å¤§å±å¹•æ˜¾ç¤º</strong>ï¼šè¯·ä½¿ç”¨ screen.html é¡µé¢å…¨å±æ˜¾ç¤º</p>
                <p>â€¢ <strong>ç®¡ç†åå°</strong>ï¼šå½“å‰é¡µé¢ï¼Œç”¨äºèŠ‚ç›®ç®¡ç†å’Œæ•°æ®æŸ¥çœ‹</p>
            </div>
        </section>
    </div>

    <script>
        // ==================== åç«¯APIæ¨¡æ‹Ÿ ====================
        
        // ä½¿ç”¨localStorageæ¨¡æ‹Ÿæ•°æ®åº“
        const DB_KEY = 'voteSystemData';
        const VOTED_KEY = 'hasVoted';
        
        // åˆå§‹èŠ‚ç›®æ•°æ®
        const defaultPrograms = [
            { id: 1, name: "å¼€åœºèˆè¹ˆã€Šæ¬¢ä¹é¢‚ã€‹", votes: 0 },
            { id: 2, name: "æ­Œæ›²æ¼”å”±ã€Šå¤œç©ºä¸­æœ€äº®çš„æ˜Ÿã€‹", votes: 0 },
            { id: 3, name: "å°å“ã€ŠåŠå…¬å®¤è¶£äº‹ã€‹", votes: 0 },
            { id: 4, name: "ä¹å™¨æ¼”å¥ã€Šæœˆå…‰ä¸‹çš„å‡¤å°¾ç«¹ã€‹", votes: 0 },
            { id: 5, name: "é­”æœ¯è¡¨æ¼”ã€Šå¥‡å¹»ä¸–ç•Œã€‹", votes: 0 },
            { id: 6, name: "è¯—æ­Œæœ—è¯µã€Šé’æ˜¥ä¸‡å²ã€‹", votes: 0 }
        ];
        
        // æ•°æ®åº“API
        const DatabaseAPI = {
            // è·å–æ‰€æœ‰èŠ‚ç›®æ•°æ®
            getPrograms() {
                const data = localStorage.getItem(DB_KEY);
                if (data) {
                    return JSON.parse(data);
                } else {
                    // åˆå§‹åŒ–æ•°æ®
                    this.savePrograms(defaultPrograms);
                    return defaultPrograms;
                }
            },
            
            // ä¿å­˜èŠ‚ç›®æ•°æ®
            savePrograms(programs) {
                localStorage.setItem(DB_KEY, JSON.stringify(programs));
            },
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æŠ•ç¥¨
            hasVoted() {
                return localStorage.getItem(VOTED_KEY) === 'true';
            },
            
            // æ ‡è®°ç”¨æˆ·å·²æŠ•ç¥¨
            setVoted() {
                localStorage.setItem(VOTED_KEY, 'true');
            },
            
            // æ¸…é™¤æŠ•ç¥¨çŠ¶æ€
            clearVoteStatus() {
                localStorage.removeItem(VOTED_KEY);
                return true;
            },
            
            // é‡ç½®æ‰€æœ‰ç¥¨æ•°
            resetVotes() {
                const programs = this.getPrograms();
                programs.forEach(program => {
                    program.votes = 0;
                });
                this.savePrograms(programs);
                this.clearVoteStatus();
                return programs;
            },
            
            // æ·»åŠ æ–°èŠ‚ç›®
            addProgram(name) {
                const programs = this.getPrograms();
                const newId = programs.length > 0 ? Math.max(...programs.map(p => p.id)) + 1 : 1;
                programs.push({
                    id: newId,
                    name: name,
                    votes: 0
                });
                this.savePrograms(programs);
                return programs;
            },
            
            // åˆ é™¤èŠ‚ç›®
            deleteProgram(programId) {
                const programs = this.getPrograms();
                const programIndex = programs.findIndex(p => p.id === programId);
                
                if (programIndex !== -1) {
                    const deletedProgram = programs.splice(programIndex, 1)[0];
                    this.savePrograms(programs);
                    return { success: true, message: `èŠ‚ç›®"${deletedProgram.name}"å·²åˆ é™¤` };
                } else {
                    return { success: false, message: "èŠ‚ç›®ä¸å­˜åœ¨ï¼" };
                }
            },
            
            // ä¸ºèŠ‚ç›®æŠ•ç¥¨
            voteForProgram(programId) {
                if (this.hasVoted()) {
                    return { success: false, message: "æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†ï¼" };
                }
                
                const programs = this.getPrograms();
                const program = programs.find(p => p.id === programId);
                
                if (program) {
                    program.votes += 1;
                    this.savePrograms(programs);
                    this.setVoted();
                    return { success: true, message: "æŠ•ç¥¨æˆåŠŸï¼" };
                } else {
                    return { success: false, message: "èŠ‚ç›®ä¸å­˜åœ¨ï¼" };
                }
            },
            
            // å¯¼å‡ºæ•°æ®
            exportData() {
                const programs = this.getPrograms();
                let csvContent = "èŠ‚ç›®åç§°,ç¥¨æ•°\n";
                programs.forEach(program => {
                    csvContent += `"${program.name}",${program.votes}\n`;
                });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "ä¸­ç§‹æ™šä¼šæŠ•ç¥¨ç»“æœ.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };
        
        // ==================== å‰ç«¯åº”ç”¨é€»è¾‘ ====================
        
        // å›¾è¡¨å®ä¾‹
        let resultsChart = null;
        
        // å½“å‰é€‰ä¸­çš„èŠ‚ç›®ID
        let selectedProgramId = null;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        // åˆå§‹åŒ–åº”ç”¨
        function initializeApp() {
            initializeProgramList();
            initializeProgramManagerList();
            initializeChart();
            updateVoteCount();
            checkVoteStatus();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('voteBtn').addEventListener('click', handleVote);
            document.getElementById('resetVotes').addEventListener('click', handleResetVotes);
            document.getElementById('addProgram').addEventListener('click', handleAddProgram);
            document.getElementById('deleteProgram').addEventListener('click', handleDeleteProgram);
            document.getElementById('exportData').addEventListener('click', handleExportData);
            document.getElementById('clearStorage').addEventListener('click', handleClearStorage);
        }
        
        // åˆå§‹åŒ–èŠ‚ç›®åˆ—è¡¨
        function initializeProgramList() {
            const programList = document.getElementById('programList');
            programList.innerHTML = '';
            
            const programs = DatabaseAPI.getPrograms();
            
            programs.forEach(program => {
                const programItem = document.createElement('div');
                programItem.className = 'program-item';
                programItem.dataset.id = program.id;
                
                programItem.innerHTML = `
                    <div class="program-name">${program.name}</div>
                    <div class="program-votes">${program.votes}ç¥¨</div>
                `;
                
                // å¦‚æœç”¨æˆ·å·²æŠ•ç¥¨ï¼Œç¦ç”¨ç‚¹å‡»
                if (!DatabaseAPI.hasVoted()) {
                    programItem.addEventListener('click', function() {
                        selectProgram(program.id);
                    });
                } else {
                    programItem.style.cursor = 'not-allowed';
                    programItem.style.opacity = '0.7';
                }
                
                programList.appendChild(programItem);
            });
        }
        
        // åˆå§‹åŒ–èŠ‚ç›®ç®¡ç†åˆ—è¡¨
        function initializeProgramManagerList() {
            const programManagerList = document.getElementById('programManagerList');
            programManagerList.innerHTML = '';
            
            const programs = DatabaseAPI.getPrograms();
            
            if (programs.length === 0) {
                programManagerList.innerHTML = '<p style="text-align:center;padding:10px;">æš‚æ— èŠ‚ç›®</p>';
                return;
            }
            
            programs.forEach(program => {
                const programItem = document.createElement('div');
                programItem.className = 'program-manager-item';
                
                programItem.innerHTML = `
                    <div class="program-manager-name">${program.name}</div>
                    <div>
                        <span style="color:#f1c40f;margin-right:10px;">${program.votes}ç¥¨</span>
                        <button class="delete-program-btn" data-id="${program.id}">åˆ é™¤</button>
                    </div>
                `;
                
                // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
                const deleteBtn = programItem.querySelector('.delete-program-btn');
                deleteBtn.addEventListener('click', function() {
                    const programId = parseInt(this.dataset.id);
                    handleDeleteSpecificProgram(programId);
                });
                
                programManagerList.appendChild(programItem);
            });
        }
        
        // é€‰æ‹©èŠ‚ç›®
        function selectProgram(programId) {
            selectedProgramId = programId;
            
            // æ›´æ–°UIæ˜¾ç¤ºé€‰ä¸­çš„èŠ‚ç›®
            document.querySelectorAll('.program-item').forEach(item => {
                if (parseInt(item.dataset.id) === programId) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            // å¯ç”¨æŠ•ç¥¨æŒ‰é’®
            document.getElementById('voteBtn').disabled = false;
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initializeChart() {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            const programs = DatabaseAPI.getPrograms();
            
            const colors = generateColors(programs.length);
            
            resultsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: programs.map(p => p.name),
                    datasets: [{
                        label: 'å¾—ç¥¨æ•°',
                        data: programs.map(p => p.votes),
                        backgroundColor: colors.bgColors,
                        borderColor: colors.brColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'white',
                                precision: 0
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white',
                                maxRotation: 45,
                                minRotation: 0
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });
        }
        
        // å®Œå…¨é‡æ–°åˆ›å»ºå›¾è¡¨ï¼ˆå½“æ·»åŠ æˆ–åˆ é™¤èŠ‚ç›®æ—¶è°ƒç”¨ï¼‰
        function recreateChart() {
            if (resultsChart) {
                resultsChart.destroy();
            }
            initializeChart();
        }
        
        // æ›´æ–°ç¥¨æ•°ç»Ÿè®¡
        function updateVoteCount() {
            const voteCount = document.getElementById('voteCount');
            voteCount.innerHTML = '';
            
            const programs = DatabaseAPI.getPrograms();
            
            programs.forEach(program => {
                const voteCountItem = document.createElement('div');
                voteCountItem.className = 'vote-count-item';
                
                voteCountItem.innerHTML = `
                    <div class="vote-count-number">${program.votes}</div>
                    <div class="vote-count-name">${program.name}</div>
                `;
                
                voteCount.appendChild(voteCountItem);
            });
        }
        
        // å¤„ç†æŠ•ç¥¨
        function handleVote() {
            if (selectedProgramId) {
                const result = DatabaseAPI.voteForProgram(selectedProgramId);
                
                if (result.success) {
                    alert(result.message);
                    updateDisplay();
                    checkVoteStatus();
                } else {
                    alert(result.message);
                }
            }
        }
        
        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            updateChart();
            updateVoteCount();
            updateProgramList();
            updateProgramManagerList();
        }
        
        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateChart() {
            const programs = DatabaseAPI.getPrograms();
            resultsChart.data.labels = programs.map(p => p.name);
            resultsChart.data.datasets[0].data = programs.map(p => p.votes);
            
            // æ›´æ–°é¢œè‰²
            const colors = generateColors(programs.length);
            resultsChart.data.datasets[0].backgroundColor = colors.bgColors;
            resultsChart.data.datasets[0].borderColor = colors.brColors;
            
            resultsChart.update();
        }
        
        // ç”ŸæˆåŠ¨æ€é¢œè‰²å‡½æ•°
        function generateColors(count) {
            const colors = [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(199, 199, 199, 0.7)',
                'rgba(83, 102, 255, 0.7)',
                'rgba(40, 159, 64, 0.7)',
                'rgba(210, 99, 132, 0.7)',
                'rgba(54, 62, 235, 0.7)',
                'rgba(255, 106, 86, 0.7)'
            ];
            
            const borderColors = [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(199, 199, 199, 1)',
                'rgba(83, 102, 255, 1)',
                'rgba(40, 159, 64, 1)',
                'rgba(210, 99, 132, 1)',
                'rgba(54, 62, 235, 1)',
                'rgba(255, 106, 86, 1)'
            ];
            
            // å¦‚æœèŠ‚ç›®æ•°é‡è¶…è¿‡é¢„è®¾é¢œè‰²ï¼Œå¾ªç¯ä½¿ç”¨é¢œè‰²
            const bgColors = [];
            const brColors = [];
            
            for (let i = 0; i < count; i++) {
                bgColors.push(colors[i % colors.length]);
                brColors.push(borderColors[i % borderColors.length]);
            }
            
            return { bgColors, brColors };
        }
        
        // æ›´æ–°èŠ‚ç›®åˆ—è¡¨ä¸­çš„ç¥¨æ•°æ˜¾ç¤º
        function updateProgramList() {
            const programs = DatabaseAPI.getPrograms();
            
            document.querySelectorAll('.program-item').forEach(item => {
                const programId = parseInt(item.dataset.id);
                const program = programs.find(p => p.id === programId);
                if (program) {
                    item.querySelector('.program-votes').textContent = `${program.votes}ç¥¨`;
                }
            });
        }
        
        // æ›´æ–°èŠ‚ç›®ç®¡ç†åˆ—è¡¨
        function updateProgramManagerList() {
            initializeProgramManagerList();
        }
        
        // æ£€æŸ¥æŠ•ç¥¨çŠ¶æ€
        function checkVoteStatus() {
            if (DatabaseAPI.hasVoted()) {
                document.getElementById('voteBtn').disabled = true;
                document.getElementById('voteBtn').textContent = 'å·²æŠ•ç¥¨';
                
                // ç¦ç”¨æ‰€æœ‰èŠ‚ç›®é€‰æ‹©
                document.querySelectorAll('.program-item').forEach(item => {
                    item.style.cursor = 'not-allowed';
                    item.style.opacity = '0.7';
                    item.classList.remove('selected');
                });
            } else {
                document.getElementById('voteBtn').textContent = 'æäº¤æŠ•ç¥¨ï¼ˆé¢„è§ˆï¼‰';
            }
        }
        
        // å¤„ç†é‡ç½®ç¥¨æ•°
        function handleResetVotes() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç¥¨æ•°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                DatabaseAPI.resetVotes();
                updateDisplay();
                checkVoteStatus();
                alert('æ‰€æœ‰ç¥¨æ•°å·²é‡ç½®ï¼');
            }
        }
        
        // å¤„ç†æ¸…é™¤æŠ•ç¥¨çŠ¶æ€
        function handleClearStorage() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æŠ•ç¥¨çŠ¶æ€å—ï¼Ÿç”¨æˆ·å°†å¯ä»¥é‡æ–°æŠ•ç¥¨ã€‚')) {
                DatabaseAPI.clearVoteStatus();
                checkVoteStatus();
                initializeProgramList();
                alert('æŠ•ç¥¨çŠ¶æ€å·²æ¸…é™¤ï¼');
            }
        }
        
        // å¤„ç†æ·»åŠ èŠ‚ç›®
        function handleAddProgram() {
            const programName = prompt('è¯·è¾“å…¥æ–°èŠ‚ç›®åç§°ï¼š');
            if (programName && programName.trim() !== '') {
                DatabaseAPI.addProgram(programName.trim());
                // å®Œå…¨æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                recreateChart();
                updateVoteCount();
                initializeProgramList();
                updateProgramManagerList();
                checkVoteStatus();
                alert('èŠ‚ç›®æ·»åŠ æˆåŠŸï¼ç°åœ¨å¯ä»¥åœ¨å›¾è¡¨ä¸­çœ‹åˆ°æ–°èŠ‚ç›®äº†ã€‚');
            }
        }
        
        // å¤„ç†åˆ é™¤èŠ‚ç›®ï¼ˆé€‰æ‹©åˆ é™¤ï¼‰
        function handleDeleteProgram() {
            const programs = DatabaseAPI.getPrograms();
            
            if (programs.length === 0) {
                alert('å½“å‰æ²¡æœ‰èŠ‚ç›®å¯ä»¥åˆ é™¤ï¼');
                return;
            }
            
            let programList = 'è¯·é€‰æ‹©è¦åˆ é™¤çš„èŠ‚ç›®ï¼š\n\n';
            programs.forEach((program, index) => {
                programList += `${index + 1}. ${program.name} (${program.votes}ç¥¨)\n`;
            });
            
            const choice = prompt(programList + '\nè¯·è¾“å…¥èŠ‚ç›®ç¼–å·ï¼š');
            if (choice && !isNaN(choice)) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < programs.length) {
                    const programId = programs[index].id;
                    handleDeleteSpecificProgram(programId);
                } else {
                    alert('æ— æ•ˆçš„èŠ‚ç›®ç¼–å·ï¼');
                }
            }
        }
        
        // å¤„ç†åˆ é™¤ç‰¹å®šèŠ‚ç›®
        function handleDeleteSpecificProgram(programId) {
            const programs = DatabaseAPI.getPrograms();
            const program = programs.find(p => p.id === programId);
            
            if (program && confirm(`ç¡®å®šè¦åˆ é™¤èŠ‚ç›®"${program.name}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                const result = DatabaseAPI.deleteProgram(programId);
                if (result.success) {
                    // å®Œå…¨æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                    recreateChart();
                    updateVoteCount();
                    initializeProgramList();
                    updateProgramManagerList();
                    checkVoteStatus();
                    
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„èŠ‚ç›®ï¼Œæ¸…é™¤é€‰æ‹©
                    if (selectedProgramId === programId) {
                        selectedProgramId = null;
                        document.getElementById('voteBtn').disabled = true;
                    }
                    
                    alert(result.message);
                } else {
                    alert(result.message);
                }
            }
        }
        
        // å¤„ç†å¯¼å‡ºæ•°æ®
        function handleExportData() {
            DatabaseAPI.exportData();
        }
    </script>
</body>
</html>